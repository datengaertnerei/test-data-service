<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BankGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Test data service</a> &gt; <a href="index.source.html" class="el_package">com.datengaertnerei.test.dataservice.bank</a> &gt; <span class="el_source">BankGenerator.java</span></div><h1>BankGenerator.java</h1><pre class="source lang-java linenums">/*MIT License

Copyright (c) 2020 Jens Dibbern

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

package com.datengaertnerei.test.dataservice.bank;

import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import java.time.LocalDate;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;
import java.util.Random;

import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVRecord;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.iban4j.CountryCode;
import org.iban4j.Iban;
import org.springframework.stereotype.Service;

/**
 * Spring Boot service to generate valid bank accounts
 *
 */
@Service
public class BankGenerator implements IBankGenerator {
	private static final String DEFAULT_CITY = &quot;frankfurt am main&quot;;

<span class="fc" id="L52">	private static Log log = LogFactory.getLog(BankGenerator.class);</span>

	private Map&lt;String, Map&lt;String, Bank&gt;&gt; bankDirectory;
	private Map&lt;String, String&gt; binList;
	private Random rnd;

<span class="fc" id="L58">	public BankGenerator() {</span>
<span class="fc" id="L59">		rnd = new Random();</span>
<span class="fc" id="L60">		rnd.setSeed(System.currentTimeMillis());</span>

<span class="fc" id="L62">		initBankDirectory();</span>
<span class="fc" id="L63">		initBinList();</span>
<span class="fc" id="L64">	}</span>

	private void initBinList() {
<span class="fc" id="L67">		binList = new HashMap&lt;&gt;();</span>
<span class="fc" id="L68">		InputStream inStream = getClass().getResourceAsStream(&quot;binlist.csv&quot;);</span>
<span class="fc" id="L69">		Reader in = new InputStreamReader(inStream);</span>

		Iterable&lt;CSVRecord&gt; records;
		try {
<span class="fc" id="L73">			records = CSVFormat.Builder.create().setDelimiter(';').build().parse(in);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">			for (CSVRecord r : records) {</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">				if (r.size() &gt;= 2) {</span>
<span class="fc" id="L76">					String type = r.get(0);</span>
<span class="fc" id="L77">					String bin = r.get(1);</span>
<span class="fc" id="L78">					binList.put(bin, type);</span>
				}
<span class="fc" id="L80">			}</span>
<span class="nc" id="L81">		} catch (IOException e) {</span>
<span class="nc" id="L82">			log.fatal(&quot;could not read BIN list&quot;, e);</span>
<span class="fc" id="L83">		}</span>

<span class="fc" id="L85">	}</span>

	private void initBankDirectory() {
<span class="fc" id="L88">		bankDirectory = new HashMap&lt;&gt;();</span>
<span class="fc" id="L89">		Map&lt;String, String&gt; bics = new HashMap&lt;&gt;();</span>
		try {
			// get german bank codes from
			// https://www.bundesbank.de/de/aufgaben/unbarer-zahlungsverkehr/serviceangebot/bankleitzahlen/
			// and just use entries with checksum routine 00
<span class="fc" id="L94">			InputStream inStream = getClass().getResourceAsStream(&quot;banklist.csv&quot;);</span>
<span class="fc" id="L95">			Reader in = new InputStreamReader(inStream);</span>

<span class="fc" id="L97">			Iterable&lt;CSVRecord&gt; records = CSVFormat.Builder.create().setDelimiter(';').setSkipHeaderRecord(true).build()</span>
<span class="fc" id="L98">					.parse(in);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">			for (CSVRecord r : records) {</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">				if (r.size() &gt;= 5) {</span>
<span class="fc" id="L101">					String bankCode = r.get(0);</span>
<span class="fc" id="L102">					String desc = r.get(3);</span>
<span class="fc" id="L103">					String city = r.get(2);</span>
<span class="fc" id="L104">					String bic = r.get(4);</span>

<span class="pc bpc" id="L106" title="2 of 4 branches missed.">					if (null == bic || 0 == bic.length()) {</span>
<span class="nc" id="L107">						bic = bics.get(bankCode);</span>
					} else {
<span class="fc" id="L109">						bics.put(bankCode, bic);</span>
					}

<span class="fc" id="L112">					Bank b = new Bank(bankCode, desc, bic, city);</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">					if (bankDirectory.containsKey(city.toLowerCase())) {</span>
<span class="fc" id="L114">						Map&lt;String, Bank&gt; cityMap = bankDirectory.get(city.toLowerCase());</span>
<span class="fc" id="L115">						cityMap.put(bankCode, b);</span>
<span class="fc" id="L116">					} else {</span>
<span class="fc" id="L117">						Map&lt;String, Bank&gt; cityMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L118">						cityMap.put(bankCode, b);</span>
<span class="fc" id="L119">						bankDirectory.put(city.toLowerCase(), cityMap);</span>
					}
				}
<span class="fc" id="L122">			}</span>
<span class="nc" id="L123">		} catch (IOException e) {</span>
<span class="nc" id="L124">			log.fatal(&quot;could not read bank list&quot;, e);</span>
<span class="fc" id="L125">		}</span>
<span class="fc" id="L126">	}</span>

	@Override
	public BankAccount generateAccount(String city) {
		// create valid internal account number
<span class="fc" id="L131">		Integer num = rnd.nextInt(999999999);</span>
<span class="fc" id="L132">		int[] toCalc = Integer.toString(num).chars().map(c -&gt; c - '0').toArray();</span>
<span class="fc" id="L133">		Integer crc = calculateCheckDigit(toCalc);</span>

		// and convert to string
<span class="fc" id="L136">		String rawAccount = num.toString() + crc.toString();</span>
<span class="fc" id="L137">		String account = &quot;0000000000&quot;.substring(rawAccount.length()) + rawAccount;</span>

		// get banks for city or default
<span class="fc" id="L140">		Map&lt;String, Bank&gt; cityMap = bankDirectory.getOrDefault(city.toLowerCase(), bankDirectory.get(DEFAULT_CITY));</span>

		// fetch random bank from list
<span class="fc" id="L143">		int bankIndex = rnd.nextInt(cityMap.keySet().size());</span>
<span class="fc" id="L144">		Optional&lt;Bank&gt; bankContainer = cityMap.values().stream().skip(bankIndex).findFirst();</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">		if (bankContainer.isEmpty()) {</span>
<span class="nc" id="L146">			BankAccount result = new BankAccount();</span>
<span class="nc" id="L147">			result.setComment(&quot;internal error while retrieving bank from list&quot;);</span>
<span class="nc" id="L148">			return result;</span>
		}
<span class="fc" id="L150">		Bank bank = bankContainer.get();</span>
		// and build IBAN
<span class="fc" id="L152">		Iban iban = new Iban.Builder().countryCode(CountryCode.DE).bankCode(bank.getBankCode()).accountNumber(account)</span>
<span class="fc" id="L153">				.build();</span>

		// combine to result
<span class="fc" id="L156">		BankAccount result = new BankAccount();</span>
<span class="fc" id="L157">		result.setBank(bank);</span>
<span class="fc" id="L158">		result.setIban(iban.toString());</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">		if (!result.getBank().getCity().equalsIgnoreCase(city)) {</span>
<span class="fc" id="L160">			result.setComment(&quot;city not found in bank directory, switched to default&quot;);</span>
		}

<span class="fc" id="L163">		return result;</span>
	}

	@Override
	public CreditCard generateCreditCard() {
		// fetch random bin from list
<span class="fc" id="L169">		int binIndex = rnd.nextInt(binList.keySet().size());</span>
<span class="fc" id="L170">		Optional&lt;String&gt; bin = binList.keySet().stream().skip(binIndex).findFirst();</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">		if (bin.isEmpty()) {</span>
<span class="nc" id="L172">			return new CreditCard(null, null, null, LocalDate.now());</span>
		}

		// create valid cc number
<span class="fc" id="L176">		String randomPart = Integer.toString(rnd.nextInt(999999999));</span>
<span class="fc" id="L177">		String combined = bin.get() + &quot;000000000&quot;.substring(randomPart.length()) + randomPart;</span>
<span class="fc" id="L178">		int[] toCalc = combined.chars().map(c -&gt; c - '0').toArray();</span>
<span class="fc" id="L179">		Integer crc = calculateCheckDigit(toCalc);</span>

		// and convert to string
<span class="fc" id="L182">		String number = combined + crc.toString();</span>

		// CVC must be 3 digits
<span class="fc" id="L185">		int cvc = rnd.nextInt(899) + 100;</span>

		// create expiry date in the future, min. 6 months, max. 4 years
<span class="fc" id="L188">		LocalDate expiry = LocalDate.now().plusDays(rnd.nextInt(1250) + 210L);</span>

		// combine to result
<span class="fc" id="L191">		return new CreditCard(number, binList.get(bin.get()), Integer.toString(cvc), expiry);</span>
	}

	// calculate checksum for domestic account number, IBAN checksum is included in
	// IBAN builder
	private int calculateCheckDigit(int[] digits) {

		/* double every other starting from right - jumping from 2 in 2 */
<span class="fc bfc" id="L199" title="All 2 branches covered.">		for (int i = digits.length - 1; i &gt;= 0; i -= 2) {</span>
<span class="fc" id="L200">			digits[i] += digits[i];</span>

			/* taking the sum of digits grater than 10 - simple trick by substract 9 */
<span class="fc bfc" id="L203" title="All 2 branches covered.">			if (digits[i] &gt;= 10) {</span>
<span class="fc" id="L204">				digits[i] = digits[i] - 9;</span>
			}
		}
<span class="fc" id="L207">		int sum = 0;</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">		for (int i = 0; i &lt; digits.length; i++) {</span>
<span class="fc" id="L209">			sum += digits[i];</span>
		}
		/* multiply by 9 step */
<span class="fc" id="L212">		sum = sum * 9;</span>

<span class="fc" id="L214">		return sum % 10;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>