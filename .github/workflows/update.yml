name: update-data

concurrency: dev-build

on: 
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '30 2 10 3,6,9,12 *'
    
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@1d9871f0c592ab955b91e5744892890950701a87
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443
            www.bundesbank.de:443          

      - uses: actions/checkout@27135e314dd1818f797af1db9dae03a9f045786b

      - name: Set up Python 
        uses: actions/setup-python@03eb867e3d1d557bdb958602013c4b401deef7a0
        with:
          python-version: 3.x
          
      - name: Fetch data
        run: |
          git checkout -B update-data
          cd src/tools
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          python blz_fetcher.py
          wc -l banklist.csv
          if [[ $(wc -l < banklist.csv) -ge 100 ]];then  
            git pull origin update-data
            cp banklist.csv ../main/resources/com/datengaertnerei/test/dataservice/bank
            git config --global user.email "jens.dibbern@gmail.com"
            git config --global user.name "datengaertnerei"
            git commit -m "Action commit: new bank data" ../main/resources/com/datengaertnerei/test/dataservice/bank
            git push --set-upstream origin update-data
          fi
        env:        
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create pull request - must run with a different GH token to allow merge check action trigger
      - name: Create pull request to dev
        id: cpr_dev
        run: gh pr create --base $BASE --head $HEAD --title "$TITLE" --body "$BODY"
        env:
          GITHUB_TOKEN: ${{ secrets.REL_SECRET }}
          HEAD: update-data
          BASE: develop
          TITLE: "Merge updated data to dev"
          BODY: ":crown: *An automated PR*"
