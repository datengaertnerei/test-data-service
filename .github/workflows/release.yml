# This workflow will build a Java project with Maven
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: maven-release

concurrency: dev-build

on: workflow_dispatch
    
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: 17
        distribution: 'temurin'
                
    - name: Create Maven release
      run: |
        git config --global user.email "jens.dibbern@gmail.com"
        git config --global user.name "datengaertnerei"
        export OSM_IMPORT_FILE=https://github.com/datengaertnerei/test-data-service/raw/develop/data/osm-small.pbf
        export MVNVER=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        export RELTAG="RB-${MVNVER}"
        echo $RELTAG
        git branch $RELTAG
        git checkout $RELTAG
        mvn clean release:prepare
        mvn release:perform 
      env:        
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Merge Maven release
      run: |
        git config --global user.email "jens.dibbern@gmail.com"
        git config --global user.name "datengaertnerei"
        
        git fetch origin
        git switch master
        git merge --squash --no-commit --no-edit $RELTAG
        git commit -m "Merge ${MVNVER}"
        git push
      env:        
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
